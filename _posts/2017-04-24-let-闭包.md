---
layout: post
title: let 闭包问题
---

### let解决闭包问题

之前用react做一个项目，用了es6的let去定义变量，没有用babel编译，在firefox和chrome都正常运行，后来测试的时候在360下无法运行。发现是let定义的问题，浏览器版本不支持，就把let直接改成var了。功能依旧有问题，才发现我在写代码的时候用了闭包，访问不到渐变量，于是嵌套了一个匿名函数，解决了闭包的问题。反过头来思考，发现之前用let定义变量的时候，并没有闭包的问题。难道let定义的变量会直接进入闭包函数的运行环境，而不是在调用闭包函数的时候从外部加载，感到十分好奇。
所以找资料去了解其中的原理。大致解释如下
#### 正常用法
~~~
var a=[];
for(var i=0;i<10;i++){
	a[i]=function(){
	console.log(i);
}
}
a[1]();//10
a[5]();//10
~~~
循环中定义了一个匿名闭包函数，其实这个比较好理解，这时候的匿名函数并没有运行，只是在内存中定义了方法。直到我们调用a[1]()和a[5]()的时候，这时候匿名函数才开始运行，console.log(i)会去执行环境中找变量i，这时候的i因为在循环中已经运行过了，早已从0递增至10.所以a[1]()和a[5]()均输出10。

~~~
var a=[];
for(let i=0;i<10;i++){
	a[i]=function(){
	console.log(i);
}
}
a[1]();//1
a[5]();//5
console.log(i);// i is not defined
~~~
let因为是块状域变量，只会在块之间运行。也可以看到，在外部i是访问不到的。在调用a[1]()和a[5]()时，i其实已经加在匿名函数的执行环境了，实际的执行应该是
~~~
{
let i=1;
a[1]=function(){
	console.log(i);
	}
}

~~~

~~~
{
let i=5;
a[5]=function(){
	console.log(i);
	}
}

~~~

